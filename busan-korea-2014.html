<!DOCTYPE html>
<html>
<head>
<title>釜山-韩国-2014</title>
<meta charset='utf8'>
<meta http-equiv="X-UA-Compatible" content="chrome=1">

<link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
<link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
<link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon">
<style>
* {
    margin: 0; padding: 0;
    font: 16px "Microsoft YaHei", Arial, Sans-Serif;
}
html {height: 100%;}
body {
    margin: auto; 
    height: 100%;
}
.galleria {width: 600px; height: 800px; margin-top: 10px;}
.bottom_music_control {
    display:none;
    font-weight: bold;
    position: fixed;
    width: 100%; height: 40px;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 999999;
}
.bottom_left_music_info {
    position: absolute;
    height: 100%; width: 80px;
    top: 0;
}
.bottom_left_music_info .music_slide {
    border-bottom-color: #FFFFFF;
}
.bottom_left_music_info .music_slide .music_bar {
    background-color: #FFFFFF;
}
.bottom_left_music_info .spinner {
    right: 12px; top: 12px;
    border-left-color: rgba(255, 255, 255, 0.5);
    border-top-color: rgba(255, 255, 255, 0.55);
    border-right-color: rgba(255, 255, 255, 0.6);
    border-bottom-color: rgba(255, 255, 255, 0.7);
}
.mini_music_status {
    position: relative;
    margin: 0 auto;
    height: 100%; width: 512px;
}
.mini_duration_bar {
    position: absolute;
    background-color: rgba(0, 0, 0, 0.7);
    width: 512px; height: 10%;
    left: 1px;
    display: none;
}
.mini_elaspe_bar {
    position: absolute; 
    height: 100%;
    background-color: #b5e853;
}
.mini_music_name {
    position: absolute;
    color: #FFFFFF;
    width: 100%; height: 36px; line-height: 36px;
    text-align: center;
    vertical-align: middle;
    left: 0; bottom: 0;
    cursor: default;
}
.mini_control .mini_pre_button, .mini_play_button, .mini_next_button {
    opacity: 0.8;
}
.mini_control .mini_pre_button:hover, .mini_play_button:hover, .mini_next_button:hover {
    cursor: pointer;
    opacity: 1;
}
.mini_pre_button .pre_button_triangle {
    border-right-color: #FFFFFF;
    right: 16px; top: 11px;
}
.mini_pre_button {
    position: absolute; 
    height: 100%; width: 32%; left: 0; top: 0;
}
.mini_pre_button .pre_button_rect {
    background-color: #FFFFFF;
    left: 16px; top: 11px;
}
.mini_play_button {
    position: absolute; 
    height: 100%; width: 32%; left: 34%; top: 0;
}
.mini_play_button .play_button_triangle {
    border-left-color: #FFFFFF;
    left: 18px; top: 10px;
}
.mini_play_button .pause_button_rect_x_2 {
    border-left-color: #FFFFFF;
    border-right-color: #FFFFFF;
    left: 16px; top: 11px;
}
.mini_next_button {
    position: absolute; 
    height: 100%; width: 32%; left: 68%; top: 0;
}
.mini_next_button .next_button_triangle {
    border-left-color: #FFFFFF;
    left: 16px; top: 11px;
}
.mini_next_button .next_button_rect {
    background-color: #FFFFFF;
    right: 16px; top: 11px;
}
.bottom_left_music_info {
    position: absolute;
    height: 100%; width: 80px;
    top: 0;
}
.bottom_left_music_info .music_slide {
    border-bottom-color: #FFFFFF;
}
.bottom_left_music_info .music_slide .music_bar {
    background-color: #FFFFFF;
}
.bottom_left_music_info .spinner {
    right: 12px; top: 12px;
    border-left-color: rgba(255, 255, 255, 0.5);
    border-top-color: rgba(255, 255, 255, 0.55);
    border-right-color: rgba(255, 255, 255, 0.6);
    border-bottom-color: rgba(255, 255, 255, 0.7);
}
.music_slide {
    position: absolute;
    width: 20px; height: 18px;
    border-bottom: solid 2px rgba(0, 0, 0, 0.6);
    right: 12px; top: 12px;
}
.music_slide .music_bar {
    position: absolute;
    width: 3px;
    background-color: rgba(0, 0, 0, 0.6);
    bottom: 0;
}
@keyframes spinner_rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@-moz-keyframes spinner_rotate {
    from { -moz-transform: rotate(0deg); }
    to { -moz-transform: rotate(360deg); }
}
@-webkit-keyframes spinner_rotate {
    from { -webkit-transform: rotate(0deg); }
    to { -webkit-transform: rotate(360deg); }
}
@-o-keyframes spinner_rotate {
    from { -o-transform: rotate(0deg); }
    to { -o-transform: rotate(360deg); }
}
.spinner {
    position: absolute; 
    -moz-border-radius: 10px; -webkit-border-radius: 10px; border-radius: 10px;
    border-left: solid 5px rgba(0, 0, 0, 0.3);
    border-top: solid 5px rgba(0, 0, 0, 0.35);
    border-right: solid 5px rgba(0, 0, 0, 0.4);
    border-bottom: solid 5px rgba(0, 0, 0, 0.5);
    width: 10px; height: 10px;
    animation: spinner_rotate 0.7s linear 0s infinite;
    -moz-animation: spinner_rotate 0.7s linear 0s infinite;
    -webkit-animation: spinner_rotate 0.7s linear 0s infinite;
    -o-animation: spinner_rotate 0.7s linear 0s infinite;
}
/*
footer {
    padding: 18px 0;
    margin-top: 32px;
    height: 64px;
    bottom: 0;
}
footer h2 {
    text-align: center;
    opacity: 0.6;
}
*/
</style>
</head>
<body>

<header>
    <div class="container">
        <h1>釜山-韩国-2014</h1>
    </div>
</header>

<div class="container">
        <audio controls="controls" id="player" autoplay="autoplay" loop="loop" type="audio/mpeg"></audio>
        <div style="position: absolute; right: 30px; top: 5px;">
            Janice - Please
        </div>
        <div class="galleria"></div>
</div>

<div class="bottom_music_control">
    <div class="bottom_left_music_info"></div>
    <div class="mini_music_status">
        <div class="mini_duration_bar">
            <div class="mini_elaspe_bar"></div>
        </div>
        <div class="mini_music_name"></div>
    </div>
    <div class="mini_control">
        <div class="mini_pre_button">
            <div class="pre_button_rect"></div>
            <div class="pre_button_triangle"></div>
        </div>
        <div id="mini_play_control" class="mini_play_button">
            <div class="play_button_triangle"></div>
            <!--
            <div class="pause_button_rect_x_2"></div>
            -->
        </div>
        <div class="mini_next_button">
            <div class="next_button_triangle"></div>
            <div class="next_button_rect"></div>
        </div>
    </div>
    <div class="back_to_top">
        <div class="back_to_top_triangle">
            <div class="back_to_top_rect"></div>
        </div>
    </div> 
</div>

<div class="music_slide" style="display:none">
    <div style="left: 2px; height: 1px;"></div>
    <div style="left: 5px; height: 1px;"></div>
    <div style="left: 8px; height: 1px;"></div>
    <div style="left: 11px; height: 1px;"></div>
    <div style="left: 14px; height: 1px;"></div>
</div>

<footer><p>busuncle</p></footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37200104-2', 'busuncle.github.io');
  ga('send', 'pageview');

</script>
<script src="./javascripts/jquery.min.js"></script>
<script src="./javascripts/galleria/galleria-1.4.2.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
        var music_name = "Janice - Please";
        for(var i = 1; i <= 73; i++){
            $(".galleria").append('<img src="images/busan/' + i + '.jpg" />');
        }
        Galleria.loadTheme("./javascripts/galleria/themes/classic/galleria.classic.min.js");
        Galleria.run(".galleria");
        var player = $("#player").get(0);
        var music_controller = {
            play_mode: 0,
            duration_time: null,
            button_locked: false,
            change_elaspe_show: function(ratio){
                // for mini_elaspe_bar
                $(".mini_elaspe_bar").width($(".mini_duration_bar").width() * ratio);
            },
            add_music_slide: function(){
                var left_start = 2;
                var left_end = 14;
                var left_delta = 3;
                var animate_time = 500;
                function recursive_slide(bar){
                    var height_ratio = null;
                    var time_delta = null;
                    if(player.paused){
                        height_ratio = "5%";
                        time_delta = 500;
                    } else {
                        height_ratio = parseInt(Math.random() * 100) + "%";
                        time_delta = Math.random() * animate_time;
                    }
                    setTimeout(function(){
                        bar.animate({height: height_ratio}, animate_time).animate({height: "0%"}, animate_time, function(){
                            recursive_slide(bar);
                        });
                    }, time_delta);
                }
                function append_to_some_object(obj){
                    if(obj.find(".music_slide").length == 0){
                        // clean other div first if necessary
                        obj.find("div").remove();
                        var music_slide = $("<div>");
                        music_slide.attr("class", "music_slide");
                        var left = left_start;
                        while(left <= left_end){
                            var bar = $("<div>");
                            bar.attr("class", "music_bar");
                            bar.css("left", left);
                            bar.css("height", 0);
                            music_slide.append(bar);
                            recursive_slide(bar);
                            left += left_delta;
                        }
                        obj.append(music_slide);
                    }

                }
                var bottom_left_music_info = $(".bottom_left_music_info");
                append_to_some_object(bottom_left_music_info);
            },
            run: function(){
                var elaspe_time = convert_seconds_to_time(player.currentTime);
                $(".elaspe_time").text(elaspe_time);
                if(!this.duration_time){
                    // a trick, player doesn't return exact duration immediately
                    var duration_time = convert_seconds_to_time(player.duration);
                    if(duration_time){
                        $(".duration_time").text(duration_time);
                        this.duration_time = duration_time;
                    }
                }
                if(!this.button_locked){
                    var elaspe_ratio = player.currentTime / player.duration;
                    this.change_elaspe_show(elaspe_ratio);
                }
                // add music_slide to the current playing music
                this.add_music_slide();
            },
            stop: function(){
                this.duration_time = null;
                this.change_elaspe_show(0);
                $("#mini_play_control").find("div").removeClass("pause_button_rect_x_2").addClass("play_button_triangle");
                //$(".mini_music_name").text("");
                $(".bottom_left_music_info div.music_slide").remove();
                $(".bottom_left_music_info div.spinner").remove();
            },
            start: function(){
                $(".mini_music_name").text(music_name);
                $(".bottom_left_music_info .spinner").remove();
                $(".mini_music_status .mini_duration_bar").show();
                if(!player.paused){
                    $("#mini_play_control").find("div").removeClass("play_button_triangle").addClass("pause_button_rect_x_2");
                }
            }
        }

        function convert_seconds_to_time(seconds){
            // assume no more than 99 * 60 seconds
            if(isNaN(seconds)){
                return null;
            }
            var m = parseInt(seconds / 60);
            var s = parseInt(seconds % 60);
            m = m >= 10 ? m : "0" + m;
            s = s >= 10 ? s : "0" + s;
            return m + ":" + s;
        }

        function auto_set_volume(ratio){
            player.volume = parseFloat(ratio);
        }

        var mouse_is_down = false;

        $("#mini_play_control").click(function(){
            if(player.paused){
                $("#mini_play_control").find("div").removeClass("play_button_triangle").addClass("pause_button_rect_x_2");
                player.play();
            } else {
                $("#mini_play_control").find("div").removeClass("pause_button_rect_x_2").addClass("play_button_triangle");
                player.pause(); 
            }
        });

        function add_spinner_to_current_playing(){
            // spinner at bottom left
            $(".bottom_left_music_info").html($('<div class="spinner"></div>'));
        }

        player.addEventListener("loadstart", function(){
            $(".mini_music_name").text("歌曲加载中...");
            $(".mini_duration_bar").hide();
            add_spinner_to_current_playing();
        });

        player.addEventListener("waiting", function(){
            add_spinner_to_current_playing();
        });

        player.addEventListener("canplay", music_controller.start);
        player.addEventListener("canplaythrough", music_controller.start);
        player.addEventListener("timeupdate", function(){
            music_controller.run();
        });

        player.addEventListener("error", function(){
            var error_msg = "加载失败 :(";
            if(player.error.code == 4){
                error_msg = "加载失败，浏览器无法播放此格式，建议用Chrome :(";
            }
            $(".mini_music_name").text(error_msg);
            $(".bottom_left_music_info .spinner").remove();
            $("#mini_play_control").find("div").removeClass("pause_button_rect_x_2").addClass("play_button_triangle");
        });

        $(window).resize(function(){
            /*
            $(".mini_control").css("left", $(".music_list").offset().left + $(".music_list").width());
            $(".bottom_left_music_info").css("left", $(".music_list").offset().left - $(".bottom_left_music_info").width());
            */
        });

        auto_set_volume(0.5);
        player.src = "./music/" + music_name + ".mp3";
        player.play();
    });
</script>

</body>
</html>

